## 签名规则

### 签名算法

#### 说明

	将发送或者接收到的所有数据假定位为集合M，将集合内非空的参数值按照参数名ASCII码从小到大排序，使用URL请求键值对参数方式进行拼接成字符串，类似`key1=value1&key2=value2`这样的格式。需要注意如下原则：

- 参数名ASCII码从小到大排序（字典序）
- 如果参数值为空不进行签名
- 参数名不区分大小写
- 进行验签时，`sign`字段不参与签名，将生成的签名与该`sign`值作校验

将上面生成的参数后追加上 `sign=秘钥`（追加后格式为 `key1=value1&key2=value2&key=秘钥`），然后将该字符串转换为大写，然后进行数据摘要算法计算出 `sign`值，并将`sign`值添加到请求中进行发送。

> 数据摘要支持`MD5`和`HmacSHA256`两种，使用`HmacSHA256`时，key值为秘钥

#### 样例

```jave
import cn.bootx.platform.daxpay.param.channel.AliPayParam;
import cn.bootx.platform.daxpay.param.channel.WeChatPayParam;
import cn.bootx.platform.daxpay.param.pay.PayParam;
import cn.bootx.platform.daxpay.param.pay.PayWayParam;
import cn.hutool.json.JSONUtil;
import com.ijpay.core.kit.PayKit;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;

import java.util.Arrays;
import java.util.List;
import java.util.Map;

/**
 * 支付签名服务
 * @author xxm
 * @since 2023/12/24
 */
@Slf4j
class PaymentSignServiceTest {

    @Test
    void toMap() {
        PayParam payParam = new PayParam();
        payParam.setBusinessNo("123");
        payParam.setClientIp("127.0.0.1");
        payParam.setNotNotify(true);
        payParam.setNotReturn(true);
        payParam.setNotifyUrl("http://127.0.0.1:8080/pay/notify");
        payParam.setReturnUrl("http://127.0.0.1:8080/pay/return");
        payParam.setVersion("1.0");

        PayWayParam p1 = new PayWayParam();
        p1.setAmount(100);
        p1.setChannel("wechat");
        p1.setWay("wx_app");
        AliPayParam aliPayParam = new AliPayParam();
        aliPayParam.setAuthCode("6688");
        p1.setChannelExtra(JSONUtil.toJsonStr(aliPayParam));

        PayWayParam p2 = new PayWayParam();
        p2.setAmount(100);
        p2.setChannel("wechat");
        p2.setWay("wx_app");
        WeChatPayParam weChatPayParam = new WeChatPayParam();
        weChatPayParam.setOpenId("w2qsz2xawe3gbhyyff28fs01fd");
        weChatPayParam.setAuthCode("8866");
        p2.setChannelExtra(JSONUtil.toJsonStr(weChatPayParam));
        List<PayWayParam> payWays = Arrays.asList(p1, p2);
        payParam.setPayWays(payWays);
        Map<String, String> map = payParam.toMap();
       
        log.info("map: {}",map);
        String data = PayKit.createLinkString(map);
        log.info("拼接字符串: {}",data);
        String sign = "123456";
        data += "&sign="+sign;
        data = data.toUpperCase();
        log.info("添加秘钥并转换为大写的字符串: {}",data);
        log.info("MD5: {}",PayKit.md5(data));
        log.info("HmacSHA256: {}",PayKit.hmacSha256(data,sign));

    }

}
```

输出:

```shell
map: {
businessNo=123,
clientIp=127.0.0.1,
notifyUrl=http://127.0.0.1:8080/pay/notify,
notNotify=true,
notReturn=true,
payWays=[
{"amount":"100","channel":"wechat","channelExtra":"{\"authCode\":\"6688\"}","way":"wx_app"},{"amount":"100","channel":"wechat","channelExtra":"{\"openId\":\"w2qsz2xawe3gbhyyff28fs01fd\",\"authCode\":\"8866\"}","way":"wx_app"}
], 
reqTime=1703520421443, 
returnUrl=http://127.0.0.1:8080/pay/return, 
version=1.0}


拼接字符串: businessNo=123&clientIp=127.0.0.1&notNotify=true&notReturn=true&notifyUrl=http://127.0.0.1:8080/pay/notify&payWays=[{"amount":"100","channel":"wechat","channelExtra":"{\"authCode\":\"6688\"}","way":"wx_app"},{"amount":"100","channel":"wechat","channelExtra":"{\"openId\":\"w2qsz2xawe3gbhyyff28fs01fd\",\"authCode\":\"8866\"}","way":"wx_app"}]&reqTime=1703520421443&returnUrl=http://127.0.0.1:8080/pay/return&version=1.0

添加秘钥并转换为大写的字符串: BUSINESSNO=123&CLIENTIP=127.0.0.1&NOTNOTIFY=TRUE&NOTRETURN=TRUE&NOTIFYURL=HTTP://127.0.0.1:8080/PAY/NOTIFY&PAYWAYS=[{"AMOUNT":"100","CHANNEL":"WECHAT","CHANNELEXTRA":"{\"AUTHCODE\":\"6688\"}","WAY":"WX_APP"},{"AMOUNT":"100","CHANNEL":"WECHAT","CHANNELEXTRA":"{\"OPENID\":\"W2QSZ2XAWE3GBHYYFF28FS01FD\",\"AUTHCODE\":\"8866\"}","WAY":"WX_APP"}]&REQTIME=1703520421443&RETURNURL=HTTP://127.0.0.1:8080/PAY/RETURN&VERSION=1.0&SIGN=123456

MD5: dd65525274d485bb365f81064db5f72a

HmacSHA256: 9ca7a0122b75209d8bd5fabdb9ea329285563baa7aef31cd1cb895c0d7dcf097
```

