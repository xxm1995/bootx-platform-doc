# 签名规则

## 说明

将发送或者接收到的所有数据假定位为集合M，将集合内非空的参数值按照参数名`ASCII码`从小到大排序，使用URL请求键值对参数方式进行拼接成字符串，类似`key1=value1&key2=value2`这样的格式。需要注意如下原则：

- 参数名ASCII码从小到大排序（字典序）
- 如果参数值为空不进行签名
- 参数名不区分大小写
- 进行验签时，`sign`字段不参与签名，将生成的签名与该`sign`值作校验

将上面生成的参数后追加上 `sign=秘钥`（追加后格式为 `key1=value1&key2=value2&key=秘钥`），然后将该字符串转换为大写，然后进行数据摘要算法计算出 `sign`值，并将`sign`值添加到请求中进行发送。

> 数据摘要支持`MD5`和`HmacSHA256`两种，使用`HmacSHA256`时，key值为秘钥

## Java样例

```jave
package cn.bootx.platform.daxpay.sdk.util;

import cn.bootx.platform.daxpay.sdk.code.PayChannelEnum;
import cn.bootx.platform.daxpay.sdk.code.PayWayEnum;
import cn.bootx.platform.daxpay.sdk.param.pay.PayChannelParam;
import cn.bootx.platform.daxpay.sdk.param.pay.PayParam;
import lombok.extern.slf4j.Slf4j;
import org.junit.Test;

import java.util.Collections;
import java.util.List;
import java.util.Map;

/**
 * 参数签名测试类
 * @author xxm
 * @since 2024/2/7
 */
@Slf4j
public class PayParamSignTest {

    /**
     * 签名测试
     */
    @Test
    public void sign(){

        PayParam param = new PayParam();
        param.setClientIp("127.0.0.1");
        param.setNotNotify(true);
        param.setNotReturn(true);

        param.setBusinessNo("P0001");
        param.setTitle("测试接口支付");
        PayChannelParam payChannelParam = new PayChannelParam();
        payChannelParam.setChannel(PayChannelEnum.WECHAT.getCode());
        payChannelParam.setWay(PayWayEnum.QRCODE.getCode());
        payChannelParam.setAmount(1);

        List<PayChannelParam> payChannels = Collections.singletonList(payChannelParam);
        param.setPayChannels(payChannels);

        Map<String, String> map = PaySignUtil.toMap(param);
        log.info("转换为有序MAP后的内容: {}",map);
        String data = PaySignUtil.createLinkString(map);
        log.info("将MAP拼接字符串: {}",data);
        String sign = "123456";
        data += "&sign="+sign;
        data = data.toUpperCase();
        log.info("添加秘钥并转换为大写的字符串: {}",data);
        log.info("MD5: {}",PaySignUtil.md5(data));
        log.info("HmacSHA256: {}",PaySignUtil.hmacSha256(data,sign));
    }
}

```

输出:

```shell

转换为有序MAP后的内容: {businessNo=P0001, clientIp=127.0.0.1, notNotify=true, notReturn=true, payChannels=[{"amount":"1","channel":"wechat_pay","way":"qrcode"}], title=测试接口支付, version=1.0}

将MAP拼接字符串: businessNo=P0001&clientIp=127.0.0.1&notNotify=true&notReturn=true&payChannels=[{"amount":"1","channel":"wechat_pay","way":"qrcode"}]&title=测试接口支付&version=1.0

添加秘钥并转换为大写的字符串: BUSINESSNO=P0001&CLIENTIP=127.0.0.1&NOTNOTIFY=TRUE&NOTRETURN=TRUE&PAYCHANNELS=[{"AMOUNT":"1","CHANNEL":"WECHAT_PAY","WAY":"QRCODE"}]&TITLE=测试接口支付&VERSION=1.0&SIGN=123456

MD5: 74b0b5b9c86ecf7910f0692fe70c3434

HmacSHA256: ffbcafb707e589377dbe06eb516ccac99947a326cab1a2426a37c18dfa641e15
```

