# 功能模块

## Core核心功能包
包含项目执行时必须的一系列注解、枚举、基础类、基础接口、基础异常等相关对象定义，是系统开发和运行必不可少的一个模块。
## 通用功能组件
::: tip 说明
通常会在系统中有可视化的界面，部分功能和参数可以进行可视化的配置。区别于[工具配置封装](#工具配置封装)下的模块，这下面模块可以视为一个mini版的功能系统，功能相对比较复杂一点。
:::
### 审计日志模块
记录系统运行时发生的各类业务审计日志，包含登录、操作、数据版本等日志，通过提供的注解或方法，在需要记录的地方进行标注，就会相应时机记录下对应的信息。
支持将日志存储到关系型数据库中，如`MySQL`，也支持存储到`MongoDB`中，默认保存到的是关系型数据库，可以通过更改配置文件来使其保存到MongoDB中。
### 认证模块
基于`Sa-Token`和`justAuth`进行封装，未选择Spring Security原因是复杂度较高，且同时对在前后端分离环境下支持一般。未选择`Shiro`是因为`Sa-Token`已经足够成熟，
API对中小项目来说更加直观和简单易用。
已实现功能：
- 支持多终端配置，可分别管理Vue2版管理端、Vue3版管理端、小程序关联的登录方式（通过IAM模块实现）
- 提供账号密码登录、短信登录、开放平台登录，同时支持方便的扩展新的登录方式
- 支持接口添加`@IgnoreAuth`来实现未登录访问、跳过权限控制等处理
- 支持进行多维度的请求权限控制，可以是配置文件，也可以代码、注解和在线进行配置
### 代码生成模块
支持前后端代码的生成，支持生成对应的Java、Vue2、Vue3、TypeScript代码。
### 数据权限模块
在生产系统中，不用不同用户和角色不光每个人看到菜单是不同的，对可读取到的数据也是如此。根据系统中配置的数据权限关系，通过对执行的SQL语句进行拦截、解析、重新组织，来实现数据权限的隔离。
同时为了符合国家信息安全法的相关规定，对存储的尽管信息需要进行脱敏或者加密。对此数据权限模块封装此类需求的实现，已实现下列功能：
- 数据字段字段加密解密，在数据库中存储AES加密后的内容，预防信息被脱裤后导致信息泄露
- 返回数据信息敏感信息脱敏，后端信息返回给前端时，对一些敏感信息进行脱敏，如密码、秘钥等，防止保密信息被流出，可以结合数据字段加密一起使用
- 数据权限控制，通过在线配置，实现不同的用户可以查询到不同范围的数据，更好的实现数据分级管理
### 钉钉对接模块
钉钉是众多打工人工作中常用的一款办公IM工具，我们开发的各类系统通常需要与钉钉打通，其中以OA、ERP、绩效类系统最为常见。不同的公司对于与钉钉对接的功能要求各不相同，有些只需要视同钉钉的登录，
有些是把整个公司运转过程都放到了钉钉上面。作为一个偏通用型的的脚手架项目，只对钉钉常用的接口进行了对接，如钉钉授权登录、消息发送、机器人管理等。
### 文件管理模块
文件上传是一个使用频度极高的功能，常见的有文件上传到服务器，上传并存储到数据库中，上传到类似S3这类云存储中，这个模块就是对这几种常见的文件上传进行了封装，便于开发时使用，
文件存储方式：
- 本地文件
- MongoDB
- minio【开发中】
- 阿里云OSS【开发中】
### 工作流模块
工作流在OA系统中是一个不可或缺的角色，在OA系统现在如此之高的普及情况下，工作流对很大一部分的应用系统都是刚需，所以最终选用之前超流行`Activity`的下一代工作流引擎`Flowable`，
配合`Bpmn.js`流程图组件作为流程设计器，并基于它们进行裁剪封装，提取出常用的功能进行保留，并对`Behavior`进行重写，便于二次开发使用，目前已完成如下功能：
- 流程节点人员动态配置
- 跳过当前节点配置
- 流程串签多任务处理
- 流程会签多任务处理
- 流程模型校验功能
- 流程任务委派
- 流程驳回处理，支持普通任务和多实例任务
- 支持按比例、一票通过通过任务
### 系统监控模块
应用投入生产后，对其进行监控是一种必要的行为，在中大型项目中，通常会引入各种`agent`、监控端点对应用各方面的指标进行监控，常见的中间件有`prometheus`、`Spring Boot Admin`，
尤其分布式项目中使用频度极高。但对于小型项目，很难应用上这些中间件，所以对这种情况，对系统中一些主要指标进行监控并实时输出，方便用户进行查看，目前已经进行监控的功能模块：
- 系统信息、JVM信息
- Redis信息
- MongoDB信息【开发中】
### 定时任务模块
定时任务是一种在开发时高频度使用到的功能，同时也是一个非常成熟的技术，在技术上选型时，最终选择了`XXL-Job`和`Quartz`，虽然功能更加强大和易用，但由于需要单独部署控制端，
且在内外网通信情况下需要做额外处理，相比较之下，`Quartz`更适合单体项目。为此针对`Quartz`开发了一套简单的可视化操作界面，方便进行使用。
### 微信对接模块
微信作为国民软件自然不需要多说什么，业务系统对接微信最常见的功能就是消息推送和对公众号进行管理，目前对消息推送相关能力进行了封装，并在`通知服务`进行了处理，
公众号管理则实现了素材管理、自定义菜单管理。其他如客服、票券能力、消息智能回复会在后期陆续开发并实装。
### 企业微信对接模块
类似钉钉，企业微信也是众多打工人常使用的一块办公IM，不过功能稍弱于钉钉，生态也有一定的差距，包括接口功能、对接能力等，与跟钉钉对接一样，也是只针对常用的功能进行了封装，
如企微授权登录、消息发送、机器人管理等。
## 工具配置封装
::: tip 说明
对一些中间件，进行与系统整合的配置，使之更适合所针对业务场景。同时对一些常用功能，主要是一些并不需要进行可视化界面配置的功能进行封装.
最后就是对一些中间件进行的增强或裁剪，都归到了工具配置封装下，相较于[通用功能组件](#通用功能组件)，这块的功能会更专注于某几个点，职责更单一
:::
### 缓存配置
针对Spring Cache的Redis实现进行了增强配置，新增了以下特性：
- 扩展RedisCache缓存管理器，存储null值时不报错
- 扩展支持无侵入的缓存过期时间配置，通过yaml中可以进行配置
- 针对缓存的Java泛型对象常遇到的无法反序列化，尤其以`List`、抽象类或接口类型的字段尤为常见，更改序列化时保存管理类型信息，保证反序列化时的正常
### 异常处理器
对项目异常进行统一处理，返回统一`ErrorResult`格式的json返回给前端，`ErrorResult`包含对应错误链路追踪ID，通过`traceId`可以定位整个错误链路，
同时也可以通过配置，来决定返回的异常是否包含详细的报错信息，如SQL执行失败的报错，默认为关闭状态，可以在开发环境中打开这个选项，方便开发测试，在生产环境下关闭，
预防泄露敏感信息。
### 请求头获取工具
获取请求头中的数据，并可以在**异步与多线程**场景下的代码中获取。通过创建一个web过滤器，每次请求到来时，获取请求头的所有请求头数据存储到TTL容器（`TransmittableThreadLocal`）里，
并在请求结束后自动清除数据。
### 幂等控制组件
只对部分不可以请求的接口，会在网络不好、用户误操作的情况下发起重复的请求，会造成数据的错误，所以必须阻止这种现象的发生。所以引入幂等控制组件来解决这个问题，
通过在要进行幂等控制的方法上添加`@Idempotent`注解，就可以自动实现幂等控制。
### 分布式锁
使用`lock4j`作为分布式锁组件，原有基于`hzero`的分布式锁组件不再使用，虽然原有锁组件功能更强大，支持可重入锁、公平锁、联锁、红锁、读锁、写锁等所终类型的锁，
但使用后发现目前的项目状态并不需要这么多功能，只需要一个简单的排它锁就已经足够，同时因为原有的锁组件是基于`Redisson`开发，造成项目中有两套Redis连接，通过替换为`lock4j`，
去除了`Redisson`的强制依赖，降低了系统的复杂度。
### Json序列化配置
对项目中使用的`Jackson`组件以及被用到的场景进行配置，例如Spring MVC进行参数和结果转换场景，根据项目的需求进行配置，同时提供出一些开箱即用的工具类和Spring Bean。主要功能如下：
- 提供JacksonUtil工具类，用于需要进行Jackson解析的场合
- 提供 java8 时间序列化类，在Jackson序列化时对JDK8新增的时间类进行支持
- 提供Long 类型序列化为String类型的序列化类，处理前端长整形精度丢失问题
- 提供一个默认的ObjectMapper序列化配置Bean，支持jdk8，LongToString等配置
- 提供 typeObjectMapper 序列化配置Bean，记录序列化对象的类型信息，主要用于需要记录类型的持久化场合
- 提供Jackson2ObjectMapper相关配置（Spring MVC进行参数和结果转换），支持jdk8，LongToString等配置
### 日志配置
覆盖重写SLF4J的MDC，引入`TTL`，使其支持简单轻量的同步异步链路追踪功能，提供默认的`logback.xml`配置文档，可以快速引入默认的控制台输出、ELK日志、收集的配置，
同时支持日志中的敏感数据脱敏的功能
### MongoDB配置
暂时未做特殊的配置
### mqtt配置（停用）
在对接物联网设备时，MQTT是一个非常常见协议，对此，对MQTT操作做一下简单的封装，方便开发时使用，提供默认的 MqttClient 终端，方便发送消息，
提供对MQTT消息通知便捷配置方式，方便配置使用。目前主题订阅有发生异常后无法自动重连的问题，不推荐使用。
### Mybatis Plus扩展
持久层框架作为系统运行中最核心的模块之一，它的稳定性和易用性直接能决定了整个项目上限。所以，为了使MP（Mybatis Plus）与项目能结合的更加顺畅，
对一些自带的功能进行了修改和扩展，同时也对项目中如何使用MP做了定义和配置，主要包括下列几个方面：
- 提供`MpBaseEntity`、`MpIdEntity`等一系列基础对象，作为通用数据库实体类的公共父类
- 提供`BaseManager`，作为 ServiceImpl 的增强替代，修改和扩展了一些公共方法，对`Optional`类型支持也更好一些
- 结合`BigField`注解，配合`MpUtil`工具类可以便捷的进行大字段排除
- 提供`MpUtil`工具类，包含分页对象转换、读取方法
- 修改了MP插件加载机制，使之可以配置不同插件质检的加载顺序
- 一些MP的默认配置，如逻辑删除、乐观锁、主键生成策略等
### RabbitMQ消息队列
对RabbitMQ的序列化方式进行了配置。
### Redis客户端封装和配置
封装StringRedisTemplate提供API简单的RedisClient操作工具类，封装消息Key过期事件通知机制，可以在不引入支持延时队列的消息中间件的情况下，基本满足在不严谨场合下的延时队列需求，
使用会记录类型信息的序列化方式，实现在反序列化时直接能反序列化回原始的对象类型。封装消息队列功能，支持在不引入其他消息中间件的情况下支持简单的队列功能，不过还是更推荐是用专门的消息中间件。
### 发号器（序列号生成器）
通过生成一个单调递增的队列，可以通过redis、jdbc、Mongo生成一个区间，每次获取号码时本地进行生成，区间号码用完后生成并跳到新的区间。重启项目，也会跳到下个区间，预防重复。
不适用分布式环境，因为多机器同时运行时，是程序本地进行发号，分布式不出问题的话，需要号段设得跟步长一样，然后加分布式锁。
### Spring相关配置
启用hutool的SpringUtil工具类，直接可以使用，配置线程池，并用TTL进行包装，用于异步线程中获取环境数据，如请求头信息，提供CorsFilter过滤器处理跨域请求，自动处理跨域问题。
### 超级查询器
支持根据前端传入的查询参数，动态的生成`Mybatis Plus`对应的查询`QueryWrapper`，而不再需要重复手动编写这些高度相似的代码。主要分为两类，
一种是常规的查询构造器，用于常规的普通查询，适合于大多数场合，同时对代码的改动影响较小。另一种是支持各种组合、嵌套查询的查询构造器，用于需要复杂查询的场合，
通常配合前端超级查询器组件一块使用。
### swagger3配置（SpringDoc）
所使用的的是Swagger3(SpringDoc)，不支持Swagger2相关的注解，因为Swagger2(SpringFox)已经在17年停止维护了，最新的Spirng Boot版本与Swagger2已经有不兼容的问题，
所以为了后期更少出现问题，直接使用Swagger3进行封装，，通过Spring的动态注册Bean和数据绑定功能，在容器Bean初始化之前把`GroupedOpenApi`（相当于Swagger2的`Docket`）注入到Spring容器中。
### websocket封装
针对与网页前端进行`Websocket`通信，对原生`Websocket`和 `SpringWebsocker`进行封装出连接管理器，同时也对数据格式进行标准化，方便管理会话与用户之间的关系，
可以更方便与前端进行通讯，Vue2与Vue3对应的管理端实现也做了对应适配和实现，只需要分别引入`WebsocketMixin`或`UserGlobalWebSocker`就能在此基础上简单的编写交互代码。
针对安全考虑。可以配置成只有登录状态下才可以连接`Websocket`，提供用户全局级别的Websocket 服务，方便ws消息推送。
### XXL-JOB定时任务（未启用）
封装`XXL-JOB`的配置项，可以通过在yml中配置后，就可以开启`XXL-JOB`进行使用。
## 业务模块
::: tip 说明
系统中核心功能和扩展功能的实现，包括基础的登录注册、菜单、角色、角色，扩展的人员消息通知、支付收单、工作流引擎管理等功能
:::
### 基础api功能服务
项目核心基础模块之一，提供了一系列通用的功能，主要包含了字典管理、验证码生成、参数配置等功能，同时也对一些项目要进行的一部分公共处理逻辑进行了配置，
包括但不限于数据保存更新时的审计信息记录等，同时一些无法归类的具体哪项业务的功能也放到这个模块，如动态表单、多数据源管理等，所以基础api功能服务是项目运行必须要的模块。
### 身份识别与访问管理
对系统整体的认证、鉴权、角色、菜单等功能进行管理，也是项目核心、运行时必须要的基础模块之一，主要管理下列几个方面：
- 认证管理，包括登录、鉴权、终端管理等，同时各种登录方式一些配置也在这里
- 用户和角色管理，用户与角色的创建和管理，还有两者之间的关联关系配置
- 菜单和权限码管理，前端路由就通过IAM（身份识别与访问管理）模块进行管理，同时前端页面判断是否显示的权限码也是在这里配置
- 请求权限，通过可视化界面来配置系统的接口是否了开启鉴权，以及什么样的角色可以进行访问
- 数据权限，通过创建数据角色，然后与角色关联，结合`数据权限模块`就可以控制用户可以查看的数据范围
- 开发平台的绑定，使之可以通过微信、钉钉、企微进行授权登录
### 消息通知服务
对各种方式的通知方式进行封装，并进行相对统一的管理，方便进行各种消息的推送，是一个偏支撑型的服务模块，主要支撑的通知方式如下：
- 站内信，主要支持发送系统公告(全体信息)和用户通知（指定用户），通常用于业务变动通知和发送全局的公告
- 邮件通知，通过邮箱发送指定消息给指定的用户
- 短信通知，通过公有短信网关发送短信给用户【开发中】
- 钉钉通知，主要包含普通消息、工作通知、群机器人通知三种类型消息
- 企业微信通知，与钉钉通知类似
- 微信消息通知，通过微信公众平台提供的模板消息能力，将消息推送到微信上
### 支付服务
支付在现在社会是一种高频使用的功能，尤其是在电商项目中，更是必不可少的一种能力，而且支付与金钱息息相关，开发起来相对要注意的点会比较多，功能诉求也会比较多，
对此根据之前经历过的几个电商产品的经验，对会高频遇到的一些功能，还有一些比较有特色的的需求进行了实现，主要是这几个方面：
- 支持多种支付通道，不只限于微信和支付宝，对常见的现金、储值卡、用户钱包也做了实现
- 支持多种支付方式，扫码支付、PC网站支付、H5网站支付、付款码支付
- 支持聚合支付、组合支付等常见但不好处理的的支付方式
- 与支付网关核心的接口进行了对接，支持了支付信息同步、支付定时关闭、退款、关闭订单等操作
- 抽象支付相关接口，通过策略+模板等设计模式抽象出：支付、退款、撤销、同步、超时等API接口，方便开发者进行调用
### 办公服务

### 订单服务

### 商品服务

### 销售服务

## 功能演示模块

## 启动模块

