import{_ as s,o as a,c as n,X as l}from"./chunks/framework.6909765d.js";const i=JSON.parse('{"title":"日志扩展","description":"","frontmatter":{},"headers":[],"relativePath":"platform/server/common/日志扩展.md","filePath":"platform/server/common/日志扩展.md"}'),o={name:"platform/server/common/日志扩展.md"},p=l(`<h1 id="日志扩展" tabindex="-1">日志扩展 <a class="header-anchor" href="#日志扩展">¶</a></h1><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>推荐请先阅读一下<a href="/platform/overview/config/日志收集.html">日志收集</a>的文档。</p></div><h2 id="功能" tabindex="-1">功能 <a class="header-anchor" href="#功能">¶</a></h2><ul><li>覆盖重写<code>SLF4J</code>的<code>MDC</code>，引入TTl，使其支持简单轻量的链路追踪功能</li><li>提供默认的 <code>logback.xml</code> 配置文档，提供默认的控制台输出和ELK日志收集的配置</li><li>支持敏感数据脱敏功能，见<code>SensitiveDataLogConverter</code></li></ul><h2 id="链路追踪" tabindex="-1">链路追踪 <a class="header-anchor" href="#链路追踪">¶</a></h2><p>当url请求处理过程中出现异常后，会以<code>ErrorResult</code>格式进行返回，此时会携带链路追踪ID <code>trackId</code>，可以通过它进行查询对应的方法链，具体格式可参考下面的响应参数：</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">msg</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">未登录</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">code</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10004</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">data</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:null,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">traceId</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">npcmxitj7m4e</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="数据脱敏" tabindex="-1">数据脱敏 <a class="header-anchor" href="#数据脱敏">¶</a></h2><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>敏感数据脱敏使用需要在 <code>Logback</code>xml配置文件中配置对应的转换规则，否则脱敏处理不生效， 可以通过导入<code>&lt;include resource=&quot;cn/bootx/common/log/logback-sensitive.xml&quot;/&gt;</code>来引入脱敏的日志配置。</p></div><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">&lt;!-- 敏感数据脱敏 --&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">xml</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">&lt;!--  msg、message是要进行脱敏的字段，这写字段的来源为 logback 提供  --&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">conversionRule</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">conversionWord</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">msg</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">converterClass</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cn.bootx.common.log.SensitiveDataLogConverter</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">conversionRule</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">conversionWord</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">message</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">converterClass</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cn.bootx.common.log.SensitiveDataLogConverter</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">xml</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><p>对<code>SensitiveDataLogConverter</code>类的静态代码块进行修改，添加对应的过滤规则，见下图 敏感信息配置 块代码</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SensitiveDataLogConverter</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MessageConverter</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// 过滤规则</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Map</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> REPLACE_RULES </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">HashMap</span><span style="color:#89DDFF;">&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 敏感信息配置</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// ....</span></span>
<span class="line"><span style="color:#A6ACCD;">        REPLACE_RULES</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">(</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">cardSecurity[</span><span style="color:#A6ACCD;">\\\\\\\\</span><span style="color:#C3E88D;">]*</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">[</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">s+]*:[</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">s+]*[</span><span style="color:#A6ACCD;">\\\\\\\\</span><span style="color:#C3E88D;">]*</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">)(.*?)([</span><span style="color:#A6ACCD;">\\\\\\\\</span><span style="color:#C3E88D;">]*</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">)</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">$1****$3</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        REPLACE_RULES</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">(</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">cvv[</span><span style="color:#A6ACCD;">\\\\\\\\</span><span style="color:#C3E88D;">]*</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">[</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">s+]*:[</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">s+]*[</span><span style="color:#A6ACCD;">\\\\\\\\</span><span style="color:#C3E88D;">]*</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">)(.*?)([</span><span style="color:#A6ACCD;">\\\\\\\\</span><span style="color:#C3E88D;">]*</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">)</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">$1****$3</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        REPLACE_RULES</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">(</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">cardCode[</span><span style="color:#A6ACCD;">\\\\\\\\</span><span style="color:#C3E88D;">]*</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">[</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">s+]*:[</span><span style="color:#A6ACCD;">\\\\</span><span style="color:#C3E88D;">s+]*[</span><span style="color:#A6ACCD;">\\\\\\\\</span><span style="color:#C3E88D;">]*</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">)(.*?)([</span><span style="color:#A6ACCD;">\\\\\\\\</span><span style="color:#C3E88D;">]*</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">)</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">$1****$3</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">convert</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ILoggingEvent</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">event</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">convert</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getFormattedMessage</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 过滤敏感信息</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">convert</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">msg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// ...</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div>`,12),t=[p];function e(c,r,D,y,C,F){return a(),n("div",null,t)}const E=s(o,[["render",e]]);export{i as __pageData,E as default};
